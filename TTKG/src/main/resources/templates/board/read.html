<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>read</title>
    <script src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h1 class="mb-4" th:text="${content.title}">게시글 제목</h1>
    <p class="text-muted"th:text="'작성자: ' + ${content.author} + ' | 작성일: ' + ${content.formattedCreatedAt}">작성자: 홍길동 | 작성일: 2023-09-20</p>
    <div class="card mb-4 custom-card">
        <div class="card-body" th:text="${content.body}">
            <!--<p>게시글 내용이 여기에 들어갑니다. 내용을 추가해 주세요.</p>
            <p>더 많은 내용...</p>
            <p>여기에 내용을 계속 추가하세요. 내용이 많을 경우, 스크롤이 가능하게 됩니다.</p>
            <p>예를 들어, 이 게시글은 사용자가 세로로 스크롤하여 내용을 볼 수 있도록 만들어졌습니다.</p>-->
        </div>
    </div>
    <div id="comments-section"></div>
    <div class="card mb-4 custom-card">
        <div class="comment-card-element" id="author" th:text="${user.userName}"></div>
        <div class="comment-card-element">
            <label>
                <input type="text" id="comment" placeholder="댓글을 남겨보세요">
            </label>
        </div>
        <div class="comment-card-element">
            <button class="none_content" type="button" onclick="commentSubmit()">등록</button>
        </div>
    </div>
    <a th:href="@{/board/main(category=${param.category}, page=${param.page})}" class="btn btn-primary">목록으로 돌아가기</a>
</div>
<script th:inline="javascript">
    $(document).ready(function() {
        // 페이지 로드 시 댓글을 불러옴
        loadComments();
    });
    function commentSubmit() {
        var comment = document.getElementById("comment");
        var userIdx = [[${user.userId}]];
        var boardIdx = [[${param.boardIdx}]];

        $.ajax({
            type: "POST",
            url: `/talktalkkinder/board/comment/write`,
            data: JSON.stringify({
                body: comment.value,
                userIdx: userIdx,
                boardIdx: boardIdx[0]
            }),
            contentType: "application/json",
            success: function(response) {
                console.log("commentSubmit 완료");
                comment.value = '';
                loadComments();
            },
            error: function(response) {
                console.log(response)
            }
        });
    }

    // 서버로부터 댓글 데이터를 가져와 렌더링하는 함수
    function loadComments() {
        var boardIdx = [[${param.boardIdx}]];
        $.ajax({
            type: "GET",
            url: `/talktalkkinder/board/comment/read?boardIdx=` + boardIdx, // 실제 API 경로 수정 필요
            success: function(response) {
                console.log("loadComments 완료");
                renderComments(response);  // 서버로부터 받은 댓글 데이터를 화면에 렌더링
            },
            error: function(error) {
                console.error('Error loading comments:', error);
            }
        });
    }

    // 댓글을 렌더링하는 함수
    function renderComments(comments) {
        const $commentsSection = $('#comments-section');
        $commentsSection.empty(); // 기존 댓글을 모두 지움

        // 댓글 데이터가 없을 경우 표시
        if (comments.length === 0) {
            $commentsSection.append('<p>댓글이 없습니다. 첫 번째 댓글을 작성해보세요!</p>');
        } else {
            // 댓글이 있을 경우 순회하면서 HTML 요소로 렌더링
            comments.forEach(function(comment) {
                const $commentElement = $(`
                    <div class="comment">
                        <div class="comment-header">
                            <strong>작성자: ${comment.userId}</strong>
                            <span>작성일: ${new Date(comment.createdAt).toLocaleString()}</span>
                        </div>
                        <div class="comment-body">
                            ${comment.body}
                        </div>
                    </div>
                `);

                // 댓글을 comments-section에 추가
                $commentsSection.append($commentElement);
            });
            console.log("renderComments 완료");
        }
    }
    var input = document.getElementById("comment");
    input.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            commentSubmit();
        }
    });
</script>
<script th:inline="javascript">

</script>
</body>
</html>